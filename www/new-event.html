<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>event0 | new event</title>
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.13.1/fc-4.2.1/fh-3.3.1/r-2.4.0/datatables.min.css"/>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Rubik+Microbe&display=swap" rel="stylesheet">
        <link href="main.css" rel="stylesheet">
        <script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    </head>
    <body>
        <div id="header" style="font-family: 'Rubik Microbe', cursive;">
            <h1 style="letter-spacing: 3px;font-size: 3rem;color:black;"><img src="small-tix.png" style="height:3rem;margin-bottom: -.2em;"/>    event0 - new event</h1>
        </div>
        <div id="auth">
            <div class="container">
                
                <div>
                    <!--https://codepen.io/Mestika/pen/oNzEWR-->
                    <fieldset id="buildyourform-person">
                        <legend>Staff <br /><i>Only staff members and event owners can scan you in.</i></legend>
                    </fieldset>
                    <input type="button" value="Add a staff member" class="add" id="add-person" />
                    <script>
                        $(document).ready(function() {
                            $("#add-person").click(function() {
                                var intId = $("#buildyourform div").length + 1;
                                var fieldWrapper = $("<div class=\"fieldwrapper\" id=\"person-field" + intId + "\"/>");
                                var fName = $("<label>Staff:</label><br /><input placeholder=\"staff@gmail.com\" type=\"text\" class=\"fieldname\" />");
                                var fType = $("<br />");
                                var removeButton = $("<input type=\"button\" class=\"remove\" style='background:red;font-weight:bold;' value=\"-\" />");
                                removeButton.click(function() {
                                    $(this).parent().remove();
                                });
                                fieldWrapper.append(fName);
                                fieldWrapper.append(fType);
                                fieldWrapper.append(removeButton);
                                $("#buildyourform-person").append(fieldWrapper);
                            });
                            
                        });

                    </script>
                </div>
                <div>
                    <!--https://codepen.io/Mestika/pen/oNzEWR-->
                    <fieldset id="buildyourform-tickets">
                        <legend>Tickets</legend>
                    </fieldset>
                    <input type="button" value="Add a ticket type" class="add" id="add-ticket" />
                    <script>
                        let loadTickets = function(tix){
                            tix.forEach((t)=>{
                                var intId = $("#buildyourform-tickets div").length + 1;
                                var fieldWrapper = $("<div class=\"fieldwrapper\" id=\"ticket-field" + intId + "\"/>");
                                var fName = $("<label>Ticket Label:</label><br /><input placeholder=\"staff@gmail.com\" type=\"text\" class=\"fieldname\" value=\""+t.label+"\" /><br /><label>Price:</label><br /><input placeholder=\"0\" type=\"number\" class=\"fieldname\" value=\""+t.price+"\"/><br /><label>Inventory:</label><br /><input placeholder=\"0\" type=\"number\" class=\"fieldname\" value=\""+t.max2sell+"\"/>");
                                var fType = $("<br />");
                                var removeButton = $("<input type=\"button\" class=\"remove\" style='background:red;font-weight:bold;' value=\"-\" />");
                                removeButton.click(function() {
                                    $(this).parent().remove();
                                });
                                fieldWrapper.append(fName);
                                fieldWrapper.append(fType);
                                fieldWrapper.append(removeButton);
                                $("#buildyourform-tickets").append(fieldWrapper);
                            })
                        }
                        let loadStaff = function(s){
                            s.forEach((staff)=>{
                                var intId = $("#buildyourform div").length + 1;
                                var fieldWrapper = $("<div class=\"fieldwrapper\" id=\"person-field" + intId + "\"/>");
                                var fName = $("<label>Staff:</label><br /><input placeholder=\"staff@gmail.com\" type=\"text\" class=\"fieldname\" value=\""+staff.email+"\"/>");
                                var fType = $("<br />");
                                var removeButton = $("<input type=\"button\" class=\"remove\" style='background:red;font-weight:bold;' value=\"-\" />");
                                removeButton.click(function() {
                                    $(this).parent().remove();
                                });
                                fieldWrapper.append(fName);
                                fieldWrapper.append(fType);
                                fieldWrapper.append(removeButton);
                                $("#buildyourform-person").append(fieldWrapper);
                            })
                        }
                        $(document).ready(function() {
                            $("#add-ticket").click(function() {
                                var intId = $("#buildyourform-tickets div").length + 1;
                                var fieldWrapper = $("<div class=\"fieldwrapper\" id=\"ticket-field" + intId + "\"/>");
                                var fName = $("<label>Ticket Label:</label><br /><input placeholder=\"staff@gmail.com\" type=\"text\" class=\"fieldname\" /><br /><label>Price:</label><br /><input placeholder=\"0\" type=\"number\" class=\"fieldname\" /><br /><label>Inventory:</label><br /><input placeholder=\"0\" type=\"number\" class=\"fieldname\" />");
                                var fType = $("<br />");
                                var removeButton = $("<input type=\"button\" class=\"remove\" style='background:red;font-weight:bold;' value=\"-\" />");
                                removeButton.click(function() {
                                    $(this).parent().remove();
                                });
                                fieldWrapper.append(fName);
                                fieldWrapper.append(fType);
                                fieldWrapper.append(removeButton);
                                $("#buildyourform-tickets").append(fieldWrapper);
                            });

                            let defaultTickets = getJson();
                            if(defaultTickets){
                                loadTickets(defaultTickets);
                            }
                            
                        });

                    </script>
                </div>
                
                
                <form action="#">
                    <label>Event Name</label>
                    <input id="input-eventname" type="text" style="width: 100%; padding: 12px 20px; margin: 8px 0; display: inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;" placeholder="NEW EVENT"/>
                    <label>Event Description</label>
                    <input id="input-eventdescr" type="text" style="width: 100%; padding: 12px 20px; margin: 8px 0; display: inline-block; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;" placeholder="IT WILL BE LIT"/>
                   
                    <input type="button" value="create new event" class="btn" id="new-btn" />
                </form>
                <div class="pass-link">
                    <a href="#" >Ticketing for hoomans</a>
                </div>	
            </div>
        </div>

        
        

        <script src="https://unpkg.com/realm-web/dist/bundle.iife.js"></script>
        
        <script src="jquery.json-editor.min.js"></script>
        <script type="text/javascript">
            function getJson() {
                try {
                    return JSON.parse('[{"label":"General Admission","price":10,"max2sell":100}]');
                } catch (ex) {
                    alert('Wrong JSON Format: ' + ex);
                }
            }
        </script>
       
        <script>
            $(document).ready(function () {

                window.app = new Realm.App({ id: "application-2-ntsvm" });
                if(!window.app.currentUser){
                    alert('Please login!')
                    window.location.href = "login.html";
                }else{
                    console.log('already logged in',window.app.currentUser);
                }


                function getJsonStaff() {
                    if(window.app.currentUser){
                        
                        try {
                            return JSON.parse('[{"email":"'+window.app.currentUser._profile.data.email+'"}]');
                        } catch (ex) {
                            alert('Wrong JSON Format: ' + ex);
                        }
                    }else{
                        alert('Please log in!');
                        window.location.href = "index.html";
                    }
                }
                let defaultStaff = getJsonStaff();
                if(defaultStaff){
                    loadStaff(defaultStaff);
                }
                $("#new-btn").off('click').on("click",function(){
                    
                    let event_label = $("#input-eventname").val();
                    let event_tickets = [];
                    let event_staff = [];
                    
                    $("#buildyourform-tickets div").each((t,item)=>{
                        console.log('t',t,item);
                        tmpTicket = {};
                        $(item).find('input').each((x,v)=>{
                            console.log('xxx',x,$(v).val())
                            if(x == 3){/*ignore because its just the - sign*/}
                            else{
                                switch(x){
                                    case 2:
                                        tmpTicket['max2sell'] = parseInt($(v).val(),10);
                                        break;
                                    case 1:
                                        tmpTicket['price'] = parseInt($(v).val(),10);
                                        break;
                                    case 0:
                                        tmpTicket['label'] = String($(v).val());
                                        break;
                                }
                            }
                        })
                        if(tmpTicket['max2sell'] && tmpTicket['price'] && tmpTicket['label']){
                            event_tickets.push(tmpTicket);
                        }
                    });
                    console.log('event_tickets',event_tickets)
                    if(event_tickets.length == 0){
                        alert('invalid tickets');
                        return false;
                    }

                    $("#buildyourform-person div").each((t,item)=>{
                        console.log('t',t,item);
                        tmpStaff = {};
                        $(item).find('input').each((x,v)=>{
                            console.log('xxx',x,$(v).val())
                            if(x == 1){/*ignore because its just the - sign*/}
                            else{
                                switch(x){
                                    case 0:
                                        tmpStaff['email'] = String($(v).val());
                                        break;
                                }
                            }
                        })
                        if(tmpStaff['email'] ){
                            event_staff.push(tmpStaff);
                        }
                    });
                    console.log('event_staff',event_staff)
                    if(event_staff.length == 0){
                        alert('invalid staff');
                        return false;
                    }
                    let event_descr = $("#input-eventdescr").val();
                    if(window.app.currentUser){
                        window.app.currentUser.functions.createEvent(event_label,event_tickets,event_descr,event_staff).then((y)=>{
                            console.log('y',y);
                            if(y){
                                alert('Event created.');
                                window.location.href = "event.html?event_identifier="+encodeURIComponent(event_label);
                            }else{
                                alert('No bueno.');
                            }
                        });
                    }
                    
                })
            });
            
        </script>
         
    </body>
</html>
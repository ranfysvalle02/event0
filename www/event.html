<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>event0</title>
        <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.13.1/fc-4.2.1/fh-3.3.1/r-2.4.0/datatables.min.css"/>
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Rubik+Microbe&display=swap" rel="stylesheet">
        <link href="main.css" rel="stylesheet">
        <script src="https://unpkg.com/realm-web/dist/bundle.iife.js"></script>
    </head>
    <body>
        <div id="header" style="font-family: 'Rubik Microbe', cursive;">
            <h1 style="letter-spacing: 3px;font-size: 3rem;text-align:center;color:white;"><a href="index.html" style="color:white;">event0</a></h1>
        </div>
        <div class="content-to-hide-when-small">
            <iframe style="background: #FFFFFF;border: none;border-radius: 2px;box-shadow: 0 2px 10px 0 rgba(70, 76, 79, .2);width:25%;float:left;" src="https://charts.mongodb.com/charts-rfv2-gryng/embed/charts?id=6398e3ea-721a-4803-8a2c-8d36d7fd543e&maxDataAge=30&theme=light&autoRefresh=true"></iframe>
            <iframe style="background: #FFFFFF;border: none;border-radius: 2px;box-shadow: 0 2px 10px 0 rgba(70, 76, 79, .2);width:25%;float:right;" src="https://charts.mongodb.com/charts-rfv2-gryng/embed/charts?id=6398e480-3ba8-4a5e-89aa-040f211d1f1c&maxDataAge=30&theme=light&autoRefresh=true"></iframe>
        </div>
        <div style="text-align: center;">
            <label>
                <b>Description</b>
            </label>
            <p id="event_descr">

            </p>
        </div>
        <div id="auth">
            <div id="pre-buy" class="container">
                <img style="width:100%;padding-bottom:1em;" src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fwww.ah-studio.com%2Fwp-content%2Fuploads%2F2020%2F04%2Fhouse-party-2-free-psd-flyer-template-free-psd-flyer-house-party-flyer-template.jpg&f=1&nofb=1&ipt=d285c27ac879517ffaedcbe835b34caf6b4bc24100bd589d26d9a6d35bbdaa84&ipo=images" />
                <button type="button" style="width:100%;color:black;cursor:pointer; font-weight:bold; letter-spacing:5px;padding:1em;background:green;" onClick="$('#pre-buy').hide();$('#buy-section').show();">BUY TICKET</button>                
            </div>
            <div id="buy-section" class="container" style="display: none;">
                
                
                <img style="width:100%;padding-bottom:1em;" src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fwww.ah-studio.com%2Fwp-content%2Fuploads%2F2020%2F04%2Fhouse-party-2-free-psd-flyer-template-free-psd-flyer-house-party-flyer-template.jpg&f=1&nofb=1&ipt=d285c27ac879517ffaedcbe835b34caf6b4bc24100bd589d26d9a6d35bbdaa84&ipo=images" />
                <label>Ticket Type:</label><br />
                <select id="ticket-type" style="width: 100%;">

                </select>
                <hr />
                
                <button type="button" style="width:100%;color:black;cursor:pointer; font-weight:bold; letter-spacing:5px;padding:1em;background:green;" onClick="letsGo()">BUY TICKET</button>                
                <hr />
                <h5>Don't have an account? <a href="register.html">REGISTER</a></h5>
            </div>
            <div id="ticket-section" class="container" style="display:none;margin: 0 auto;">
                
                    <img style="width:100%;padding-bottom:1em;" src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fwww.ah-studio.com%2Fwp-content%2Fuploads%2F2020%2F04%2Fhouse-party-2-free-psd-flyer-template-free-psd-flyer-house-party-flyer-template.jpg&f=1&nofb=1&ipt=d285c27ac879517ffaedcbe835b34caf6b4bc24100bd589d26d9a6d35bbdaa84&ipo=images" />
                    <img id="ticket-img" style="width:5em;margin: 0 35%;" src="" />
                    <a href="index.html">View My Tickets</a>
                
            </div>
            
            <div id="manage-evt" style="display: none;">
                <h5>Is this your event? <a id="edit-evt" href="">MANAGE</a></h5>
            </div>
        </div>

        


<script src="https://code.jquery.com/jquery-3.6.1.min.js" integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
        <script>
            const params = new URLSearchParams(window.location.search);
            let e_id = params.get("event_identifier")?params.get("event_identifier"):"DEMO";
            $("#edit-evt").attr('href',"edit-event.html?event_identifier="+e_id);
            
            var letsGo = function(){
                
                window.app.currentUser.functions.ticketGen($("#ticket-type").val(),window.app.currentUser._profile.data.email, e_id).then((y)=>{
                    console.log('y',y);
                    let s = y;
                    if(s.waitlist){
                        alert("Ticket was sold out, but we've added you to the waitlist.");
                    }
                    if(s.ticket){
                        $("#ticket-img").attr('src',String(s.ticket));
                        $("#buy-section").hide();
                        $("#ticket-section").show();
                    }
                });
            }
            window.app = new Realm.App({ id: "application-2-ntsvm" });
            if(!window.app.currentUser){
                alert('Please login!')
                window.location.href = "login.html";
            }else{
                console.log('already logged in',window.app.currentUser);
            }

            $.getJSON("https://us-east-1.aws.data.mongodb-api.com/app/application-2-ntsvm/endpoint/available?event_id="+encodeURIComponent(e_id)).then((x)=>{
                console.log('x',x); //use ctt

                if(x.x.user_id == window.app.currentUser.id){
                    $("#manage-evt").show();
                }
                $("#ticket-type").html('');
                let tmpHTML = "";
                Object.keys(x.data).forEach((k)=>{
                    tmpHTML += "<option value='"+k+"'>"+k+"</option>";
                    console.log('tmpHTML',tmpHTML);
                    $("#ticket-type").html(tmpHTML); 
                })
                $("#event_descr").html(x.event)
            });
        </script>
    </body>
</html>